<!DOCTYPE html>
<html>
<head>
    <title>paint site</title>
    <link rel="icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAEACAIAAADTED8xAAAQAElEQVR4nOyd2bocxZW2I7LwAPhvGwxm0IAAgaHd3Wd9f32FfeABM4MQSIwGC2O3bXbG/3W+Hd+zIrNqayNtqWpXxjqoJysrh6jMNY+PlFJShw5rhUdShw4rhk4AHVYNnQA6rBo6AXRYNXQC6LBq6ATQYdXQCaDDqqETQIdVQyeADquGTgAdVg2dADqsGjoBdFg1dALosGroBNBh1dAJoMOqoRNAh1VDJ4AOq4ZOAB1WDZ0AOqwaOgF0WDV0AuiwaugE0GHV0Amgw6qhE8BKIaf0n/fn/1+1u46dADqsGjoB3COIg5pZlgnGcdTnj370o8hcI0PlsDwBezjF+4cJ/NPWm+qAeLrAF4yfXkNc5HL9XvZms9FXtvWpu7CHs7jI999/z08s0ku90NAJ4Jzhn//8Z5owZoaXqRJAWqgZOYB3LlUUDgDjOQB8Zb/Q0Tgdb3FyclIC+GoQqq6gA3xxjuey4LeQnm3RA1fggseB/akTwDmDMMYYGTHbzN5UsURKIB7AWXydXZD9fOqnKDG2klO8VNohLlJl80L3Rx75X9yAHiCAVGWOtqG3dPFthk4ADxzAclhpqpgN3ljlgK+LK4N2KVCI2bw58VKApBYRIwHoeGgjKkWWJKZAfwXjZ9dkA67vX9mGMC4udAI4BzA/ThOWwKpBF7N5NIe0YL3a/49//EPkwVnWvI39JoBUkdgSwEydc6M88RpmjN8bum+8kckg3kIgikQCsBNyuuhcP0IngHuEJRIw70yLFj3Yb3Q0BaSK7uC9UJ/yLV0Z/5HxWG+Dc8k4NbV5bey3BEjVSC7VXrU8o52lsJQJgN8tAUx1Fg5RBbJdEdO6l0jgQFQgxwFyc1BYXwSme0gB6VhwlARQdnzw8n7QKz1e8h4ed/T7a4RxrFH2UwKllgJNBjEaMEO16OKJgipNwSpO0X5rSjN0j5VFC5i/smvh2wKdAE7BUMlA//+gFW4zLhMg3ghT6aw/W7M2Y6a2Pl38dXo5T4bSCMf27Jx5yN5Cy0l5/yUZ6RTAKZgrSHLw/u9RAkQ2H7Gft5aHt6d0m13W6v9LntnFZ3YvPz3UAGdBsxP1NDK4xQCXyLzzsY3n+bN40RR8mq7jfJVCP0sX1v64NkzhXqC/T6ceKkP57bSp0amzXWf/x9/7a6C/XZAA9Lk0pYcsYf/WnQ8E+5EQqGSgn8YL/zwfBvL69eu3bt06Pj4+Pj6+fv36tWvXrl+/LnZ+9epVjrl8+fJLL7107dq1119/XYd99NFHH3/8sc64fPky55ZfRs8OoVkpY9kf5d9R/y1T/kE0/mC/STgxTu0UwL1j0p7oDpgaaT3R/lYbY5aqY8jJ+GHjP4cb+0ETiQ6J2FjZb6l4OP5FFiAcf+ONN957772PPvro1q1bt27fvnP7trZv37598+ZNEcC7775rMrh+/frx8fG1a9dee+214+Pjq1evXrly5caNG1evXn355ZdhAEiLGV3PXlf8O84nRJp3V8H/Z86cOfPyGzZsONywfzXoj/h9+Prrr7fZP3H7WNzL+c4pxzrxzETJ8wWxPzqI/HNm9EX0LcEW5Cb81f4ff/zRkvznn3+2jscBf/3rX+0Rkib/1Vdfccy333775ZdfYlPq09rgl19++eOPP4pR5cQbN27AAzdu3JBY0K2Pj4+1X3d844031q9fv3Hjhq7w/vvvv/3221euXNEjP/roI93ipZdeeu655y5cuHD+/PlLly7p4IsXL54/f/7cuXPPPPP8n/8Yg18++eSTTz/99JNPPjn9deHChbNnz549e/bJJ588f/782bNnn3rqqWeeeebChQsXLlzQleeJYUDfL02YPMgS5Qk0hAPBfiREqhhvfOSnP/3pT3/605/++te/2kb761//ev78+XPnzp07d+7pp58+f/78uXPnzp8//8QTT+j3E0888fjjj58/f/6RRx65cOGCznr00Ucff/zx8+fP67zz58/rRrqCvuo6P/7xj/UJ+/Ojv7A+y2Wnt7D9Mh8mHzwcl5aTCjiF/6YD65RSUvjvaaqZavOaIX51f9h/4BJAJCDiFvZf/GN6zldfffXdd9/99NNPP/74408//fTdd9/dunXrzp07t2/fvn379q1bt27dunXnzp1vvvnm66+//vbbb3/88cdff/31t99+++WXX3766aeff/75l19+0Rm//PKLqOj777//+eefdfC3336ri9y8efPbb7/95ptvJCF+/vlnff3xxx9//vln7dS5+qm79Xk+QyQUu8T+R3/605/++7//+3//939FAAL9FnqZEM6ePfvnP//Z2K+fcH+xfzGAWdE4Y7/b/f8OeHh/sfyQQy4A/u2///u/hf06BnI5e/assV/0oN8iD+0XKTz22GN8fvzxx0UN+koV0mOPPcb+c+fOnT179sknnzQBPP/88/r5+uuvS5m0hHjqqacU5nnkkUdEA+fOnZN0efLJJ3n2M2fOPPzww+ylmdKjZDry2GvNrf22wf7HxW4PBBzsYz8QkFPSf61q6vfDDz9s4if+h0Wv33/+8591gEhE2P/YY49h5z/11FOPPfbY008//eSTTz722GMXLlwQDfznP/8RAaCt/fDDD3fv3hUdiipFdX/7299+++23u3fvivR1gYcfflho/dRTTz333HOPPvqo/v6zZ8+K/Uu0mKLM9BnnE4z+JgCJXGG86UCSwURlF8qDgC4B7hHcZS5WahIw+v/nP//5r//6L0V9Yf8QOmeJokQnMg9k9p87d04EIIb6+OOPP/nkkzIexOblRBQn/eGHH7799lvdW3z2+++/lz/x999/11WEnnIX/PDDD3/961//8Y9//P3vf9dN9bCPPvqoRf6jjz5q1JcJIdYva0EGoS2fBx3nnQLuEUQ/0b0DV/uf//xn+/7B+GeeeUb+yvPnz3/zzTcw7O+//16k8s033/z2228ffPDBN998I9fuX/7yF0lCmf2ff/75J598cufOHZGQiEEWwj//+c9ffvlF+qf8jFJspP+Ljf7++++//PLLzz//LKJ6/fXXZRc988wzFy5cOH/+vCwBefrEA3j16O/E2zD8T/Vl5Wx5INEJ4B7BBKDPP/3pT1J9/vznP4sA/u///k9I/PDDDz/77LOPPvrouXPn3nrrrZ9++ukf//jHL7/8IgWJQPN7770nAvj4448//fTTO3fufP7553fv3tVheI9+/PFHnSUC+PXXX3/88UdxZv1Vjz766HPPPScC+OWXX/7+97//7W9/++GHH7755psvvvjik08+EW0gNiQH5Aj6y1/+8vTTT8tz8NBDD2EsnQnAB5ZJCRX5Dx6chdAlwD2CNSA8mzIYpP4gPWDVf/7zn4XE33///Xfffffbb7/99NNPcvkLle/evSt8/eSTTz799FOx/q+++urbb7/97rvvJA3E5qT/iBK+/vrrb775Rs7Ezz77TOzmxRdfFDa/9dZb77777t27d4X9f/vb33T6V1999cUXX3z66ac3b968efOmTBFpkp988skHH3zw5JNP2hyO2I+tE0mFaWgx/gcAnQDuEcwXFXcF6++YICQc6KGHHpLX8tFHH5Xyr30y9T/77DORwddffy1s/vrrr8X35fEXtv3666/SgUQJP//8s1SgL7744pNPPhGvf/XVV5988kkRwLvvvvv555//9NNP33333a+//qqzfvrpJ1kCMi0++uijd9999+bNm3IcyQw4e/YssdAZu6ep0tET9J8kfx8cPHAZwQPn1D84n6+1V+ThOIecmcJ+3P6imWeeeeb27ds4A0QAMgMkCeQllWX7888///LLL6IC3eju3bu3b9+WDLl58+b777//+uuvX7t27cUXX3zxxRfff//9Dz/88M6dOzoYO1cscJqg9J8vv/zy448/fu+996QG3bhx48UXXyQIwKNEf57UA2N/5I/74gJ5UAHr7J4hPPfcc+Ky+PyffPLJ11577b333pMe/+233/7www9//etfRQ9Sh5QzIWKQl0mCQZaA0hWkL7377ruvv/66aOzatWuvvvrqK6+88vHHH3/11Vfyp+qkb7/9Vr6j77///ocffvj1118lTj7++GPRiWREpIDEAA2lZ5RFE/F/7rnnHqQJoNMI7xGIHpI3qT0X5YFYtBKAdJD73+gvv6Fcp7dv3/7yyy/1KQeUogByjMrJIxGgsPCXX3757rvvvvPOO2+//fabb7758ssvv/DCCy+88MKrr776xhtviOmLWuRGEsH8/e9///nnn7/++us7d+5I2nz44YevvfbazZs333vvvXfffVeYHfMhZgN4mu8sRg8k+rtk6d8i4WU6+5eJ4D9A/RU88+xB8jzqN3kl4v3C/j/96U+yBCiM/Mtf/iLO+tJLL0k9w3KQlnXnzh0ZvNKKpFzJjL19+/Z777332muv3bhxQ3z91VdfvXbt2muvvfbuu+9+/PHH0n+k/6hO5/vvv//uu+9++OEHuZaE/ZI2H3zwwZtvvvnJJ5/curUpLfJn4Q/3V8qfxQPSgSTt/+d//se0xM7i3/BWKYq8AN5BnkeU8J//+Z8yKqNK83+gsI8+6q2P92NPxXe3buWrj9SVo8Gf8wTq6fJ6UAZn+9tS/7dP+Yf2+J+zPYJ/cJdY+79LAnU6zYtPx1I8zCdbxT34Rc8++6z+jFj9wb8K/5eBqX2q6xEHlwfg1VdfffPNN4XuUgLl3Pnll18kAEQnd+/e/fLLL+UFeuedd1577TVp/i+99NLLL7/8xhtvvPPOO/JsKl/p888///LLL7/66itcUj/99JM8Ql988cUXX3zx6aef6haffPKJ7A15qPi3eK4Z+0UKFjYkfynmfeA7/8tf/gLgQYT7y56d5wPi+iJqG5y3f5lSapX2xqC3bpqjFmeb9bemvvsx+93fH6Lf7tO9xMY+0PMePtz93K7w7RP+AewXG46fRv74LypL8fHHH5f/4dlnn33ppZdu3LghY0AuS9UQSNf6+9//LgJQFsU333yjTIY333xTrF1e/hdffPH111+Xeicn7GeffaYg3ddffy2JIf9qrDyTA/Hjjz/Wp5wJ8mydO3cu4ryxP9X4gwXq8B8UPvTQQ/8nXgF+Kf8AAAAASUVORK5CYII=" type="image/x-icon">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
        }
        body {
            font-family: sans-serif;
            background: #1e1e1e;
            color: #ccc;
            display: flex;
            height: 100vh;
            overflow: hidden;
            font-size: 14px;
        }
        #toolbar {
            width: 80px;
            background: #2d2d2d;
            border-right: 1px solid #444;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        .tool-btn {
            width: 60px;
            height: 60px;
            background: #3a3a3a;
            border: none;
            color: #ccc;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .tool-btn.active {
            background: #5555ff;
        }
        .tool-btn:hover {
            background: #4a4a4a;
        }
        #color-palette {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 10px;
            width: 100%;
        }
        .color-swatch {
            width: 25px;
            height: 25px;
            border-radius: 3px;
            margin: 3px;
            cursor: pointer;
            border: 2px solid transparent;
        }
        .color-swatch.active {
            border-color: #fff;
        }
        #custom-color-section {
            margin-top: 10px;
            width: 100%;
        }
        #color-input {
            width: 100%;
            height: 30px;
            border: 1px solid #555;
            background: #252525;
            color: #ccc;
            text-align: center;
            border-radius: 3px;
            outline: none;
            margin-bottom: 5px;
        }
        #add-color-btn {
            width: 100%;
            height: 25px;
            background: #3a3a3a;
            border: none;
            color: #ccc;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        #remove-color-btn {
            width: 100%;
            height: 25px;
            background: #ff5555;
            border: none;
            color: #fff;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            margin-top: 5px;
        }
        #layers-panel {
            width: 200px;
            background: #2d2d2d;
            border-left: 1px solid #444;
            padding: 10px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        .layer-item {
            background: #252525;
            border: 1px solid #3a3a3a;
            margin-bottom: 5px;
            padding: 8px;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
        }
        .layer-item.active {
            border-color: #5555ff;
            background: #353535;
        }
        .layer-controls {
            display: flex;
            gap: 5px;
        }
        .layer-btn {
            background: #3a3a3a;
            border: none;
            color: #ccc;
            width: 24px;
            height: 24px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 10px;
        }
        #add-layer {
            width: 100%;
            height: 30px;
            background: #3a3a3a;
            border: none;
            color: #ccc;
            border-radius: 3px;
            cursor: pointer;
            margin-top: 10px;
        }
        #remove-layer {
            width: 100%;
            height: 30px;
            background: #ff5555;
            border: none;
            color: #fff;
            border-radius: 3px;
            cursor: pointer;
            margin-top: 5px;
        }
        #main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        #top-bar {
            height: 40px;
            background: #252525;
            border-bottom: 1px solid #3a3a3a;
            display: flex;
            align-items: center;
            padding: 0 10px;
            gap: 15px;
        }
        #brush-size {
            width: 100px;
        }
        #brush-size-value {
            min-width: 30px;
        }
        #save-hint {
            margin-left: auto;
            font-size: 12px;
            color: #888;
        }
        #cursor-preview {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 1px solid #ccc;
            pointer-events: none;
            position: absolute;
            z-index: 1000;
            display: none;
            mix-blend-mode: difference;
        }
        #canvas-container {
            flex: 1;
            position: relative;
            overflow: hidden;
        }
        canvas {
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            background: transparent;
            cursor: crosshair;
        }
        #base-layer {
            background: #fff;
            z-index: 1;
        }
        .canvas-layer {
            z-index: 2;
        }
    </style>
</head>
<body>
    <div id="toolbar">
        <button class="tool-btn active" data-tool="pen" title="Pen">pen</button>
        <button class="tool-btn" data-tool="brush" title="Brush">brush</button>
        <button class="tool-btn" data-tool="eraser" title="Eraser">erase</button>
        <div id="color-palette">
            <!-- color swatches will be added here -->
        </div>
        <div id="custom-color-section">
            <input type="color" id="color-input" value="#ff5555">
            <button id="add-color-btn">add color</button>
            <button id="remove-color-btn">remove color</button>
        </div>
    </div>
    
    <div id="main">
        <div id="top-bar">
            <label>size:</label>
            <input type="range" id="brush-size" min="1" max="50" value="5">
            <span id="brush-size-value">5</span>
            <label>opacity:</label>
            <input type="range" id="brush-opacity" min="1" max="100" value="100">
            <span id="opacity-value">100%</span>
            <button id="clear-layer" title="Clear Current Layer">clear</button>
            <button id="undo-btn" title="Undo (Ctrl+Z)">undo</button>
            <button id="redo-btn" title="Redo (Ctrl+Y)">redo</button>
            <div id="save-hint">right click canvas to save image</div>
        </div>
        <div id="canvas-container">
            <canvas id="base-layer"></canvas>
            <!-- layers will be added here -->
        </div>
    </div>

    <div id="layers-panel">
        <div id="layers-list">
            <!-- layer items will be added here -->
        </div>
        <button id="add-layer">+ add layer</button>
        <button id="remove-layer">- remove layer</button>
    </div>

    <div id="cursor-preview"></div>

    <script>
        // state
        let currentTool = 'pen';
        let currentColor = '#ff5555';
        let brushSize = 5;
        let brushOpacity = 1.0;
        let activeLayerIndex = 0;
        let layers = [];
        let drawing = false;
        let lastX = 0;
        let lastY = 0;
        let undoStacks = [];
        let redoStacks = [];
        let cursorPreview = null;
        let colorPalette = [
            '#ff5555', '#55ff55', '#5555ff', '#ffff55', '#000000',
            '#ffffff', '#ff55ff', '#55ffff', '#ffaa55', '#aaaaff'
        ];

        // init
        const baseCanvas = document.getElementById('base-layer');
        const baseCtx = baseCanvas.getContext('2d');
        const container = document.getElementById('canvas-container');
        const layersList = document.getElementById('layers-list');
        const cursorElement = document.getElementById('cursor-preview');
        const colorPaletteContainer = document.getElementById('color-palette');
        const colorInput = document.getElementById('color-input');
        const addColorBtn = document.getElementById('add-color-btn');
        const removeColorBtn = document.getElementById('remove-color-btn');

        // init color palette
        function renderColorPalette() {
            colorPaletteContainer.innerHTML = '';
            colorPalette.forEach(color => {
                const swatch = document.createElement('div');
                swatch.className = 'color-swatch';
                swatch.style.backgroundColor = color;
                swatch.dataset.color = color;
                if (color === currentColor) swatch.classList.add('active');
                swatch.addEventListener('click', () => {
                    document.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('active'));
                    swatch.classList.add('active');
                    currentColor = color;
                    colorInput.value = color;
                });
                colorPaletteContainer.appendChild(swatch);
            });
        }

        // add custom color
        addColorBtn.addEventListener('click', () => {
            const color = colorInput.value.toLowerCase();
            if (!colorPalette.includes(color)) {
                colorPalette.push(color);
                renderColorPalette();
            }
        });

        // remove selected color
        removeColorBtn.addEventListener('click', () => {
            if (colorPalette.length > 1) {
                const index = colorPalette.indexOf(currentColor);
                if (index !== -1) {
                    colorPalette.splice(index, 1);
                    currentColor = colorPalette[0];
                    colorInput.value = currentColor;
                    renderColorPalette();
                }
            }
        });

        // color input change
        colorInput.addEventListener('input', () => {
            currentColor = colorInput.value;
            document.querySelectorAll('.color-swatch').forEach(s => {
                s.classList.remove('active');
                if (s.dataset.color === currentColor) s.classList.add('active');
            });
        });

        // create layer
        function createLayer(index) {
            const canvas = document.createElement('canvas');
            canvas.className = 'canvas-layer';
            canvas.style.zIndex = index + 2;
            const ctx = canvas.getContext('2d');
            container.appendChild(canvas);
            
            const layer = {
                canvas,
                ctx,
                index,
                visible: true,
                name: `Layer ${index + 1}`
            };
            layers.push(layer);
            undoStacks[index] = [];
            redoStacks[index] = [];
            
            updateLayersList();
            setActiveLayer(index);
            resizeCanvas(canvas);
            saveState(index); // save initial empty state
            return layer;
        }

        // resize canvases
        function resizeCanvas(canvas) {
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
            if (canvas === baseCanvas) {
                baseCtx.fillStyle = '#fff';
                baseCtx.fillRect(0, 0, canvas.width, canvas.height);
            }
        }

        function resizeAllCanvases() {
            resizeCanvas(baseCanvas);
            layers.forEach(layer => resizeCanvas(layer.canvas));
        }

        window.addEventListener('resize', resizeAllCanvases);
        resizeAllCanvases();

        // layers ui
        function updateLayersList() {
            layersList.innerHTML = '';
            layers.forEach((layer, idx) => {
                const item = document.createElement('div');
                item.className = `layer-item ${idx === activeLayerIndex ? 'active' : ''}`;
                item.innerHTML = `
                    <span>${layer.name}</span>
                    <div class="layer-controls">
                        <button class="layer-btn up-btn" ${idx === 0 ? 'disabled' : ''}>up</button>
                        <button class="layer-btn down-btn" ${idx === layers.length - 1 ? 'disabled' : ''}>down</button>
                        <button class="layer-btn visible-btn">${layer.visible ? 'vis' : 'hid'}</button>
                        <button class="layer-btn delete-btn" ${layers.length === 1 ? 'disabled' : ''}>del</button>
                    </div>
                `;
                item.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('layer-btn')) {
                        setActiveLayer(idx);
                    }
                });
                
                const upBtn = item.querySelector('.up-btn');
                const downBtn = item.querySelector('.down-btn');
                const visibleBtn = item.querySelector('.visible-btn');
                const deleteBtn = item.querySelector('.delete-btn');
                
                upBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (idx > 0) moveLayer(idx, idx - 1);
                });
                
                downBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (idx < layers.length - 1) moveLayer(idx, idx + 1);
                });
                
                visibleBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    layer.visible = !layer.visible;
                    layer.canvas.style.display = layer.visible ? 'block' : 'none';
                    visibleBtn.textContent = layer.visible ? 'vis' : 'hid';
                });
                
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (layers.length > 1) deleteLayer(idx);
                });
                
                layersList.appendChild(item);
            });
        }

        function setActiveLayer(idx) {
            activeLayerIndex = idx;
            updateLayersList();
        }

        function moveLayer(from, to) {
            const layer = layers.splice(from, 1)[0];
            layers.splice(to, 0, layer);
            layers.forEach((l, i) => {
                l.canvas.style.zIndex = i + 2;
                l.index = i;
            });
            if (activeLayerIndex === from) activeLayerIndex = to;
            else if (activeLayerIndex === to) activeLayerIndex = from;
            updateLayersList();
        }

        function deleteLayer(idx) {
            if (layers.length <= 1) return;
            const layer = layers[idx];
            container.removeChild(layer.canvas);
            layers.splice(idx, 1);
            undoStacks.splice(idx, 1);
            redoStacks.splice(idx, 1);
            layers.forEach((l, i) => {
                l.canvas.style.zIndex = i + 2;
                l.index = i;
            });
            if (activeLayerIndex >= layers.length) activeLayerIndex = layers.length - 1;
            setActiveLayer(activeLayerIndex);
        }

        // undo/redo
        function saveState(layerIdx) {
            const canvas = layers[layerIdx].canvas;
            const imageData = layers[layerIdx].ctx.getImageData(0, 0, canvas.width, canvas.height);
            undoStacks[layerIdx].push(imageData);
            // limit stack size
            if (undoStacks[layerIdx].length > 20) undoStacks[layerIdx].shift();
            redoStacks[layerIdx] = [];
        }

        function undo() {
            const stack = undoStacks[activeLayerIndex];
            if (stack.length <= 1) return; // keep at least one state (initial)
            const redoData = layers[activeLayerIndex].ctx.getImageData(0, 0, layers[activeLayerIndex].canvas.width, layers[activeLayerIndex].canvas.height);
            redoStacks[activeLayerIndex].push(redoData);
            stack.pop(); // remove current state
            const undoData = stack[stack.length - 1]; // get previous state
            layers[activeLayerIndex].ctx.putImageData(undoData, 0, 0);
        }

        function redo() {
            const stack = redoStacks[activeLayerIndex];
            if (stack.length === 0) return;
            const undoData = layers[activeLayerIndex].ctx.getImageData(0, 0, layers[activeLayerIndex].canvas.width, layers[activeLayerIndex].canvas.height);
            undoStacks[activeLayerIndex].push(undoData);
            const redoData = stack.pop();
            layers[activeLayerIndex].ctx.putImageData(redoData, 0, 0);
        }

        // tools
        const toolButtons = document.querySelectorAll('.tool-btn');
        toolButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                toolButtons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentTool = btn.dataset.tool;
            });
        });

        // brush size & opacity
        const brushSizeSlider = document.getElementById('brush-size');
        const brushSizeValue = document.getElementById('brush-size-value');
        const opacitySlider = document.getElementById('brush-opacity');
        const opacityValue = document.getElementById('opacity-value');
        
        brushSizeSlider.addEventListener('input', () => {
            brushSize = parseInt(brushSizeSlider.value);
            brushSizeValue.textContent = brushSize;
        });
        
        opacitySlider.addEventListener('input', () => {
            brushOpacity = parseInt(opacitySlider.value) / 100;
            opacityValue.textContent = opacitySlider.value + '%';
        });

        // clear layer
        document.getElementById('clear-layer').addEventListener('click', () => {
            const ctx = layers[activeLayerIndex].ctx;
            const canvas = layers[activeLayerIndex].canvas;
            saveState(activeLayerIndex);
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        });

        // undo/redo buttons
        document.getElementById('undo-btn').addEventListener('click', undo);
        document.getElementById('redo-btn').addEventListener('click', redo);

        // add layer button
        document.getElementById('add-layer').addEventListener('click', () => {
            createLayer(layers.length);
        });

        // remove layer button
        document.getElementById('remove-layer').addEventListener('click', () => {
            deleteLayer(activeLayerIndex);
        });

        // keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'z') {
                e.preventDefault();
                undo();
            }
            if ((e.ctrlKey || e.metaKey) && e.key === 'y') {
                e.preventDefault();
                redo();
            }
        });

        // cursor preview
        function updateCursorPreview(x, y) {
            cursorElement.style.display = 'block';
            cursorElement.style.width = `${brushSize * 2}px`;
            cursorElement.style.height = `${brushSize * 2}px`;
            cursorElement.style.borderRadius = currentTool === 'eraser' ? '0' : '50%';
            cursorElement.style.backgroundColor = currentTool === 'eraser' ? '#fff' : currentColor;
            cursorElement.style.opacity = brushOpacity;
            cursorElement.style.left = `${x - brushSize}px`;
            cursorElement.style.top = `${y - brushSize}px`;
        }

        // drawing
        function getMousePos(e) {
            const rect = container.getBoundingClientRect();
            return [
                e.clientX - rect.left,
                e.clientY - rect.top
            ];
        }

        function startDrawing(e) {
            drawing = true;
            [lastX, lastY] = getMousePos(e);
            saveState(activeLayerIndex);
        }

        function stopDrawing() {
            if (drawing) {
                drawing = false;
                layers[activeLayerIndex].ctx.beginPath();
            }
        }

        function draw(e) {
            if (!drawing) return;
            
            const [x, y] = getMousePos(e);
            const ctx = layers[activeLayerIndex].ctx;
            
            ctx.lineWidth = brushSize;
            ctx.lineCap = currentTool === 'eraser' ? 'square' : 'round';
            ctx.lineJoin = currentTool === 'eraser' ? 'miter' : 'round';
            ctx.globalAlpha = brushOpacity;
            
            if (currentTool === 'eraser') {
                ctx.strokeStyle = '#ffffff';
            } else {
                ctx.strokeStyle = currentColor;
            }
            
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(x, y);
            ctx.stroke();
            
            [lastX, lastY] = [x, y];
        }

        // mouse move for cursor preview
        container.addEventListener('mousemove', (e) => {
            const [x, y] = getMousePos(e);
            updateCursorPreview(e.clientX, e.clientY);
        });

        container.addEventListener('mouseenter', () => {
            cursorElement.style.display = 'block';
        });

        container.addEventListener('mouseleave', () => {
            cursorElement.style.display = 'none';
            stopDrawing();
        });

        // drawing events
        container.addEventListener('mousedown', (e) => {
            startDrawing(e);
        });

        container.addEventListener('mousemove', draw);
        container.addEventListener('mouseup', stopDrawing);

        // touch support
        container.addEventListener('touchstart', (e) => {
            e.preventDefault();
            if (e.touches.length === 1) {
                startDrawing(e.touches[0]);
            }
        });

        container.addEventListener('touchmove', (e) => {
            e.preventDefault();
            if (e.touches.length === 1 && drawing) {
                draw(e.touches[0]);
            }
        });

        container.addEventListener('touchend', stopDrawing);

        // right click save context menu
        container.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            // create temporary canvas with all layers
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = baseCanvas.width;
            tempCanvas.height = baseCanvas.height;
            const tempCtx = tempCanvas.getContext('2d');
            
            // draw base layer
            tempCtx.drawImage(baseCanvas, 0, 0);
            
            // draw all visible layers
            layers.forEach(layer => {
                if (layer.visible) {
                    tempCtx.drawImage(layer.canvas, 0, 0);
                }
            });
            
            // create download link
            const link = document.createElement('a');
            link.download = 'drawing.png';
            link.href = tempCanvas.toDataURL('image/png');
            link.click();
        });

        // init
        renderColorPalette();
        createLayer(0);
    </script>
</body>
</html>
